#!/usr/bin/env python3
import json
from pathlib import Path
from datetime import datetime, timezone
import xml.sax.saxutils as saxutils

INPUT_FILE = Path("data.json")
OUTPUT_FILE = Path("tal_archive.xml")

# Load episodes
with open(INPUT_FILE, "r", encoding="utf-8") as f:
    episodes = json.load(f)

def format_contributors(contribs):
    if contribs:
        return " _" + ", ".join(contribs) + "_"
    return ""

def format_description(ep):
    lines = []
    for act in ep.get("acts", []):
        act_label = "Prologue" if act["number"] == 0 else act["number_text"]
        title_line = f"{act_label}" if act["number"] == 0 else f"{act_label}: {act['title'].split(': ', 1)[-1]}"
        summary_line = act["summary"]
        if act.get("duration"):
            summary_line += f" ({act['duration']} minutes)"
        summary_line += format_contributors(act.get("contributors", []))
        lines.append(title_line)
        lines.append(summary_line)
        lines.append("")  # blank line between acts
    # Episode synopsis at the top
    full_desc = ep.get("synopsis", "").strip()
    if full_desc:
        full_desc += "\n\n"
    full_desc += "\n".join(lines)
    full_desc += f"\nOriginally Aired: {datetime.strptime(ep['original_air_date'], '%a, %d %b %Y %H:%M:%S %z').strftime('%Y-%m-%d')}"
    return saxutils.escape(full_desc)

def iso_to_rfc822(dt_str):
    dt = datetime.strptime(dt_str, "%a, %d %b %Y %H:%M:%S %z")
    return dt.strftime("%a, %d %b %Y %H:%M:%S %z")

rss_items = []

for ep in episodes:
    versions = []
    if ep.get("download"):
        versions.append(("", ep["download"]))
    if ep.get("download_clean"):
        versions.append((" (Clean)", ep["download_clean"]))

    for clean_suffix, url in versions:
        title = f"{ep['number']}: {ep['title']}"
        # Check if this is a repeat
        latest_pub = ep["published_dates"][-1]
        is_repeat = latest_pub != ep["original_air_date"]
        if is_repeat:
            title += " - Repeat"
        title += clean_suffix

        # pubDate is the latest published date
        pub_date = iso_to_rfc822(latest_pub)

        # Enclosure URL
        enclosure_url = url

        # Duration in HH:MM:SS
        total_minutes = sum(act.get("duration", 0) for act in ep.get("acts", []))
        hours, rem = divmod(total_minutes, 60)
        minutes = rem
        seconds = 0
        duration_str = f"{hours:02}:{minutes:02}:{seconds:02}"

        # Image
        image_url = ep.get("image", {}).get("url", "")

        # Explicit
        explicit = "true" if ep.get("explicit", False) else "false"

        description = format_description(ep)

        rss_item = f"""    <item>
      <title>{saxutils.escape(title)}</title>
      <link>{ep['episode_url']}</link>
      <itunes:episode>{ep['number']}</itunes:episode>
      <itunes:episodeType>full</itunes:episodeType>
      <itunes:explicit>{explicit}</itunes:explicit>
      <description>{description}</description>
      <pubDate>{pub_date}</pubDate>
      <enclosure url="{enclosure_url}" type="audio/mpeg"/>
      <itunes:duration>{duration_str}</itunes:duration>
      <itunes:image href="{image_url}"/>
    </item>"""
        rss_items.append(rss_item)

# Build final RSS
rss_feed = f"""<?xml version="1.0" ?>
<rss xmlns:itunes="http://www.itunes.com/dtds/podcast-1.0.dtd" version="2.0">
  <channel>
    <title>This American Archive</title>
    <link>https://www.thisamericanlife.org</link>
    <description>Autogenerated feed of the This American Life archive with explicit and clean episodes.</description>
    <language>en</language>
    <copyright>Copyright Â© Ira Glass / This American Life</copyright>
    <itunes:image href="https://i.imgur.com/pTMCfn9.png"/>
{chr(10).join(rss_items)}
  </channel>
</rss>
"""

# Write to file
with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
    f.write(rss_feed)

print(f"RSS feed generated: {OUTPUT_FILE}")
